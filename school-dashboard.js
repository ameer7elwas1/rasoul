const supabaseUrl = CONFIG?.SUPABASE?.URL || 'https:const supabaseKey = CONFIG?.SUPABASE?.ANON_KEY || '';const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);let currentUser = null;let currentSchool = null;let studentsData = [];let paymentsData = [];document.addEventListener('DOMContentLoaded', async () => {    const userData = localStorage.getItem('user');    if (!userData) {        window.location.href = 'index.html';        return;    }    currentUser = JSON.parse(userData);    const urlParams = new URLSearchParams(window.location.search);    const schoolId = urlParams.get('school') || currentUser.school_id;    if (!schoolId) {        alert('�� ��� ����� �������');        window.location.href = 'index.html';        return;    }    await loadSchoolData(schoolId);    document.getElementById('schoolName').textContent = currentSchool?.name || '�������';    document.getElementById('userName').textContent = currentUser.full_name || currentUser.username;    await loadDashboardStats();    await loadStudents();    await loadPayments();    await loadNotifications();    await loadMessages();    setInterval(async () => {        await loadDashboardStats();        await loadNotifications();        await loadMessages();    }, 30000);});async function loadSchoolData(schoolId) {    try {        const { data, error } = await supabase            .from('schools')            .select('*')            .eq('id', schoolId)            .single();        if (error) throw error;        currentSchool = data;    } catch (error) {        console.error('��� �� ����� ������ �������:', error);        showAlert('��� �� ����� ������ �������', 'danger');    }}function showSection(sectionId) {    document.querySelectorAll('.content-section').forEach(section => {        section.classList.remove('active');    });    document.getElementById(sectionId).classList.add('active');    document.querySelectorAll('.sidebar-item').forEach(item => {        item.classList.remove('active');    });    event.target.classList.add('active');    if (sectionId === 'students') {        loadStudents();    } else if (sectionId === 'payments') {        loadPayments();    } else if (sectionId === 'reports') {        loadReports();    } else if (sectionId === 'settings') {        loadSettings();    }}async function loadDashboardStats() {    try {        const { data: students, error } = await supabase            .from('students')            .select('*')            .eq('school_id', currentSchool.id)            .eq('is_active', true);        if (error) throw error;        let totalStudents = students.length;        let paidStudents = 0;        let partialStudents = 0;        let unpaidStudents = 0;        let totalFees = 0;        let totalPaid = 0;        students.forEach(student => {            totalFees += parseFloat(student.final_fee || 0);            let paid = 0;            if (student.installments && Array.isArray(student.installments)) {                student.installments.forEach(inst => {                    paid += parseFloat(inst.amount_paid || 0);                });            }            totalPaid += paid;            if (paid >= parseFloat(student.final_fee || 0)) {                paidStudents++;            } else if (paid > 0) {                partialStudents++;            } else {                unpaidStudents++;            }        });        document.getElementById('totalStudents').textContent = totalStudents;        document.getElementById('paidStudents').textContent = paidStudents;        document.getElementById('partialStudents').textContent = partialStudents;        document.getElementById('unpaidStudents').textContent = unpaidStudents;        document.getElementById('totalFees').textContent = Utils.formatCurrency(totalFees);        document.getElementById('remainingFees').textContent = Utils.formatCurrency(totalFees - totalPaid);    } catch (error) {        console.error('��� �� ����� ����������:', error);    }}async function loadStudents() {    try {        const { data, error } = await supabase            .from('students')            .select('*')            .eq('school_id', currentSchool.id)            .eq('is_active', true)            .order('created_at', { ascending: false });        if (error) throw error;        studentsData = data || [];        displayStudents(studentsData);    } catch (error) {        console.error('��� �� ����� ������:', error);        showAlert('��� �� ����� ������', 'danger');    }}async function loadStudentInstallments() {    const studentId = document.getElementById('studentSelect').value;    if (!studentId) {        document.getElementById('installmentsContent').innerHTML =             '<p class="text-center text-muted">���� ������ ���� ���� ������</p>';        return;    }    const student = studentsData.find(s => s.id === studentId);    if (student) {        displayStudentInstallments(student);    }}function displayStudents(students) {    const tbody = document.getElementById('studentsTableBody');    if (students.length === 0) {        tbody.innerHTML = '<tr><td colspan="9" class="text-center">�� ���� ���� ������</td></tr>';        return;    }    const studentSelect = document.getElementById('studentSelect');    if (studentSelect) {        studentSelect.innerHTML = '<option value="">���� ���� ���� ������</option>' +            students.map(s => `<option value="${s.id}">${s.name} - ${s.grade}</option>`).join('');    }    tbody.innerHTML = students.map(student => {        let paid = 0;        if (student.installments && Array.isArray(student.installments)) {            student.installments.forEach(inst => {                paid += parseFloat(inst.amount_paid || 0);            });        }        const finalFee = parseFloat(student.final_fee || 0);        let status = 'unpaid';        let statusBadge = '<span class="badge bg-danger">��� �����</span>';        if (paid >= finalFee) {            status = 'paid';            statusBadge = '<span class="badge bg-success">����� �������</span>';        } else if (paid > 0) {            status = 'partial';            statusBadge = '<span class="badge bg-warning">����� ������</span>';        }        return `            <tr>                <td>${Utils.sanitizeHTML(student.name)}</td>                <td>${Utils.sanitizeHTML(student.guardian_name)}</td>                <td>${Utils.sanitizeHTML(student.grade)}</td>                <td>${Utils.sanitizeHTML(student.phone || '-')}</td>                <td>${Utils.formatCurrency(student.annual_fee)}</td>                <td>${student.discount_percentage || 0}%</td>                <td>${Utils.formatCurrency(finalFee)}</td>                <td>${statusBadge}</td>                <td>                    <button class="btn btn-sm btn-primary" onclick="viewStudent('${student.id}')">                        <i class="bi bi-eye"></i>                    </button>                    <button class="btn btn-sm btn-success" onclick="addPayment('${student.id}')">                        <i class="bi bi-cash-coin"></i>                    </button>                    <button class="btn btn-sm btn-info" onclick="sendWhatsApp('${student.id}')">                        <i class="bi bi-whatsapp"></i>                    </button>                </td>            </tr>        `;    }).join('');}async function loadPayments() {    try {        const { data: payments, error: paymentsError } = await supabase            .from('payments')            .select(`                *,                students (                    id,                    name,                    school_id                )            `)            .eq('students.school_id', currentSchool.id)            .order('created_at', { ascending: false })            .limit(100);        if (paymentsError) throw paymentsError;        paymentsData = payments || [];        displayPayments(paymentsData);    } catch (error) {        console.error('��� �� ����� ���������:', error);        showAlert('��� �� ����� ���������', 'danger');    }}function displayPayments(payments) {    const tbody = document.getElementById('paymentsTableBody');    if (payments.length === 0) {        tbody.innerHTML = '<tr><td colspan="7" class="text-center">�� ���� �������</td></tr>';        return;    }    tbody.innerHTML = payments.map(payment => {        const student = payment.students;        return `            <tr>                <td>${Utils.sanitizeHTML(student?.name || '-')}</td>                <td>${payment.installment_number}</td>                <td>${Utils.formatCurrency(payment.amount)}</td>                <td>${Utils.formatDateArabic(payment.payment_date)}</td>                <td>${getPaymentMethodName(payment.payment_method)}</td>                <td>${Utils.sanitizeHTML(payment.receipt_number || '-')}</td>                <td>                    <button class="btn btn-sm btn-info" onclick="viewPayment('${payment.id}')" title="����� �����">                        <i class="bi bi-printer"></i>                    </button>                </td>            </tr>        `;    }).join('');}function getPaymentMethodName(method) {    const methods = {        'cash': '����',        'bank_transfer': '����� ����',        'check': '���',        'other': '����'    };    return methods[method] || method;}async function loadNotifications() {    try {        const { data, error } = await supabase            .from('admin_notifications')            .select('*')            .or(`target_schools.cs.{${currentSchool.id}},target_schools.is.null`)            .order('created_at', { ascending: false })            .limit(10);        if (error) throw error;        const unreadCount = data.filter(n => {            const readBy = n.is_read_by || {};            return !readBy[currentSchool.id];        }).length;        const badge = document.getElementById('notificationBadge');        if (unreadCount > 0) {            badge.textContent = unreadCount;            badge.style.display = 'flex';        } else {            badge.style.display = 'none';        }    } catch (error) {        console.error('��� �� ����� ���������:', error);    }}async function loadMessages() {    try {        const { data, error } = await supabase            .from('conversations')            .select('*')            .or(`sender_id.eq.${currentSchool.id},receiver_id.eq.${currentSchool.id}`)            .order('updated_at', { ascending: false });        if (error) throw error;        const unreadCount = data.reduce((sum, conv) => {            return sum + (conv.unread_count || 0);        }, 0);        const badge = document.getElementById('messageBadge');        if (unreadCount > 0) {            badge.textContent = unreadCount;            badge.style.display = 'flex';        } else {            badge.style.display = 'none';        }    } catch (error) {        console.error('��� �� ����� �������:', error);    }}function viewStudent(studentId) {    const student = studentsData.find(s => s.id === studentId);    if (!student) return;    showSection('installments');    displayStudentInstallments(student);}function addPayment(studentId) {    const student = studentsData.find(s => s.id === studentId);    if (!student) return;    const unpaidInstallment = student.installments?.find(inst =>         parseFloat(inst.amount_paid || 0) < parseFloat(inst.amount || 0)    );    if (unpaidInstallment) {        showAddPaymentModal(studentId, unpaidInstallment.installment_number);    } else {        alert('�� ��� ���� �������');    }}async function sendWhatsApp(studentId) {    if (typeof showWhatsAppModal === 'function') {        showWhatsAppModal(studentId);    } else {        const result = await sendWhatsAppReminder(studentId);        if (!result.success) {            showAlert(result.error || '��� �� ����� ����� ������', 'danger');        }    }}function logout() {    if (confirm('�� ��� ����� �� ����� �����̿')) {        localStorage.removeItem('user');        localStorage.removeItem('loginTime');        window.location.href = 'index.html';    }}function showAlert(message, type = 'info') {    const alertDiv = document.createElement('div');    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;    alertDiv.style.zIndex = '9999';    alertDiv.innerHTML = `        ${message}        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>    `;    document.body.appendChild(alertDiv);    setTimeout(() => {        alertDiv.remove();    }, 5000);}